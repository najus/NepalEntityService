name: Migration Persistence

on:
  push:
    branches: [main]
  schedule:
    # Run daily at 2 AM UTC to process any pending migrations
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  persist-migrations:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.DATABASE_REPO_TOKEN || github.token }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      
      - name: Show pending migrations
        run: |
          export NES_DB_PATH=./nes-db
          nes migration list --pending
      
      - name: Run migrations
        id: run
        run: |
          export NES_DB_PATH=./nes-db
          echo y | nes migration run --all 2>&1 | tee migration_output.txt
          echo "exit_code=$?" >> $GITHUB_OUTPUT
      
      - name: Push to Database Repository
        if: steps.run.outputs.exit_code == '0'
        run: |
          cd nes-db/
          
          # Check if there are any changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # Configure fake user for autocommit
          git config user.name "Migration Bot"
          git config user.email "migration-bot@newnepal.org"
          
          # Create autocommit branch with datetime
          DATETIME=$(date -u +"%Y%m%d-%H%M%S")
          BRANCH="autocommit-${DATETIME}"
          
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "Auto-commit migration changes - $DATETIME"
          
          # Push the branch
          timeout 600 git push origin "$BRANCH" || {
            echo "Push failed or timed out"
            exit 1
          }
          
          echo "âœ“ Successfully pushed to branch $BRANCH in Database Repository"
      
      - name: Update submodule reference and file PR
        if: steps.run.outputs.exit_code == '0'
        run: |
          # Check if submodule reference changed
          if git diff --quiet nes-db/; then
            echo "Submodule reference unchanged"
            exit 0
          fi
          
          # Configure git
          git config user.name "Migration Bot"
          git config user.email "migration-bot@nepalentity.org"
          
          # Create branch for PR
          DATETIME=$(date -u +"%Y%m%d-%H%M%S")
          BRANCH="update-submodule-${DATETIME}"
          
          git checkout -b "$BRANCH"
          git add nes-db/
          git commit -m "Update database submodule after migration execution"
          git push origin "$BRANCH"
          
          # Create PR using GitHub CLI
          gh pr create \
            --title "Update database submodule - $DATETIME" \
            --body "Automated update of nes-db submodule after migration execution." \
            --base main \
            --head "$BRANCH"
          
          echo "âœ“ Created PR for submodule update"
      
      - name: Create summary
        if: steps.run.outputs.exit_code == '0'
        run: |
          echo "## Migration Persistence Complete" >> $GITHUB_STEP_SUMMARY
          echo "Migration execution completed successfully" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Migration Persistence Failed',
              body: `Automated migration persistence failed during execution.
              
              **Workflow Run**: [View logs](${runUrl})
              **Trigger**: ${context.eventName}
              **Time**: ${new Date().toISOString()}
              
              Please investigate and resolve the issue.
              
              cc @maintainers`,
              labels: ['migration', 'urgent']
            });
