name: Migration Persistence

on:
  push:
    branches: [main]
    paths:
      - 'migrations/**'
  schedule:
    # Run daily at 2 AM UTC to process any pending migrations
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

jobs:
  persist-migrations:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true
          token: ${{ secrets.DATABASE_REPO_TOKEN || github.token }}
      
      - name: Configure Git
        run: |
          git config --global user.name "Migration Bot"
          git config --global user.email "bot@nepalentity.org"
          
          # Configure Git for large repositories
          git config --global core.preloadindex true
          git config --global core.fscache true
          git config --global gc.auto 256
          git config --global pack.threads 4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      
      - name: Check for pending migrations
        id: pending
        run: |
          # Get list of pending migrations
          PENDING=$(nes migrate pending --format=json 2>/dev/null || echo "[]")
          
          # Count pending migrations
          COUNT=$(echo "$PENDING" | python3 -c "import sys, json; print(len(json.load(sys.stdin)))" 2>/dev/null || echo "0")
          
          echo "pending_count=$COUNT" >> $GITHUB_OUTPUT
          echo "pending_migrations=$PENDING" >> $GITHUB_OUTPUT
          
          if [ "$COUNT" -gt 0 ]; then
            echo "Found $COUNT pending migration(s)"
            echo "has_pending=true" >> $GITHUB_OUTPUT
          else
            echo "No pending migrations found"
            echo "has_pending=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Execute pending migrations
        if: steps.pending.outputs.has_pending == 'true'
        id: execute
        run: |
          echo "Executing ${{ steps.pending.outputs.pending_count }} pending migration(s)..."
          
          # Execute all pending migrations with auto-commit
          # This will:
          # 1. Execute each migration script
          # 2. Create/modify files in nes-db/ submodule
          # 3. Commit changes to Database Repository
          # 4. Track execution statistics
          
          if nes migrate run --all --auto-commit 2>&1 | tee migration_output.txt; then
            echo "success=true" >> $GITHUB_OUTPUT
            
            # Extract summary statistics
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "## Migration Execution Summary" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            grep -E "(Migration:|Entities created:|Entities updated:|Relationships created:|Duration:)" migration_output.txt >> $GITHUB_OUTPUT || echo "No statistics available" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "Migration execution failed. See logs for details."
            exit 1
          fi
      
      - name: Push to Database Repository
        if: steps.pending.outputs.has_pending == 'true' && steps.execute.outputs.success == 'true'
        run: |
          cd nes-db/
          
          # Check if there are commits to push
          if git log origin/main..HEAD --oneline | grep -q .; then
            echo "Pushing commits to Database Repository..."
            
            # Push with timeout for large pushes
            timeout 600 git push origin main || {
              echo "Push failed or timed out"
              exit 1
            }
            
            echo "âœ“ Successfully pushed to Database Repository"
          else
            echo "No new commits to push"
          fi
      
      - name: Update submodule reference
        if: steps.pending.outputs.has_pending == 'true' && steps.execute.outputs.success == 'true'
        run: |
          # Check if submodule reference changed
          if git diff --quiet nes-db/; then
            echo "Submodule reference unchanged"
          else
            echo "Updating submodule reference in Service API Repository..."
            
            git add nes-db/
            git commit -m "Update database submodule after migration execution

            Executed ${{ steps.pending.outputs.pending_count }} migration(s)
            
            ${{ steps.execute.outputs.summary }}"
            
            git push origin main
            
            echo "âœ“ Successfully updated submodule reference"
          fi
      
      - name: Create summary
        if: steps.pending.outputs.has_pending == 'true'
        run: |
          echo "## Migration Persistence Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Executed ${{ steps.pending.outputs.pending_count }} migration(s)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.execute.outputs.summary }}" >> $GITHUB_STEP_SUMMARY
      
      - name: No pending migrations
        if: steps.pending.outputs.has_pending == 'false'
        run: |
          echo "No pending migrations to execute" >> $GITHUB_STEP_SUMMARY
          echo "All migrations are up to date" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on failure
        if: failure() && steps.pending.outputs.has_pending == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Migration Persistence Failed',
              body: `Automated migration persistence failed during execution.
              
              **Workflow Run**: [View logs](${runUrl})
              **Trigger**: ${context.eventName}
              **Time**: ${new Date().toISOString()}
              
              Please investigate and resolve the issue. Pending migrations may need to be executed manually.
              
              cc @maintainers`,
              labels: ['migration', 'urgent']
            });
